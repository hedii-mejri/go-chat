<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title> Go-Chat </title>
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="chat.css">
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  <script>
    var parsedUrl = {{.}};
    var jsonObj = JSON.parse(parsedUrl)
    socket_addr = 'ws://'+ jsonObj.context + '/websocket';
    var websocket = new WebSocket(socket_addr);

    console.log("Websocket - status: " + websocket.readyState);
    websocket.onopen = function(res) {
      console.log("CONNECTION opened..." + this.readyState);
      websocket.send(jsonObj.name + ' joined the chat.');
    }
    websocket.onmessage = function(res) {
      var regEx = /(.*)~~(.*)$/;
      var dataArray = regEx.exec(res.data.replace(/\n/g,'<br/>'));
      var div_id = "div" + getRandomIntInclusive(0,50000);
      var random_color = 'rgb(' + (Math.floor(Math.random() * 256)) + ',' + (Math.floor(Math.random() * 256)) + ',' + (Math.floor(Math.random() * 256)) + ')';
      if(dataArray != null && dataArray[1] != jsonObj.name){
        $('#chat_box').append('<div id="' + div_id + '"' + ' class="messages pull-left">');
        $('#' + div_id).append('<p style="color:'+random_color +'">' + '<strong>' + dataArray[1]+ '</strong>' + '</p>');
        $('#' + div_id).append('<p>' + dataArray[2] + '</p');
        $('#chat_box').append('</div><hr/>');
        $('#notify')[0].play();

      }else if (dataArray != null && dataArray[1] == jsonObj.name) {
        $('#chat_box').append('<div id="' + div_id + '"' + ' class="mymessages pull-right">');
        $('#' + div_id).append('<p>' + dataArray[2] + '</p');
        $('#chat_box').append('</div><hr/>');
      }else{
        $('#chat_box').append('<p style="text-align:center;font-weight:bold">' + res.data + '</p><br/>');
        $('#notify')[0].play();
      }
      $('#chat_box').animate({scrollTop: $('#chat_box').prop("scrollHeight")},'fast');
    }

    websocket.onerror = function(res) {
      console.log("Error occured sending..." + m.data);
    }
    websocket.onclose = function(res) {
      console.log("Disconnected - status " + this.readyState);
      websocket.send(jsonObj.name + ' left the chat.');
    }

    var getRandomIntInclusive = function (min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
  </script>

</head>
<body style="background-color: #FAFAFF;">
    <h1> Welcome to Go-Chat</h1>
    <div class="container-fluid">
      <div class="panel panel-primary">
        <div class="panel-heading">
          <span class="glyphicon glyphicon-comment"></span> Chat Box
          <div class="btn-group pull-right">
            <button id="clear_chat" class="btn btn-default btn-xs">Clear</button>
          </div>
        </div>
        <div id ="chat_box" class="panel-body msg_container_base"></div>

        <div class="panel-footer">
          <div class="input-group">
            <input id="chat_prompt" type="text" class="form-control input-sm" placeholder="Type your message here..." />
            <span class="input-group-btn">
              <button class="btn btn-warning btn-sm" id="send">Send</button>
            </span>
          </div>
        </div>
      </div>
    </div>
    <audio id="notify" preload="auto">
      <source src="http://demos.9lessons.info/notify/notify.ogg" type="audio/ogg">
      <source src="http://demos.9lessons.info/notify/notify.mp3" type="audio/mpeg">
      <source src="http://demos.9lessons.info/notify/notify.wav" type="audio/wav">
    </audio>

    <script>
      $('#chat_prompt').val('');
      $('#send').on('click',function(){
        if($('#chat_prompt').val().trim() === ""){
          return false;
        }
        websocket.send(jsonObj.name + '~~' +$('#chat_prompt').val())
        $('#chat_prompt').val('');
      });
      $('#clear_chat').on('click',function(){
        $('#chat_box').html('');
      });

      $('#chat_prompt').keypress(function (e) {
        var key = e.which;
        if(key == 13){
          $('#send').trigger('click');
          return false;
        }
      });
    </script>
</body>
</html>
